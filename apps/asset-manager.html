
<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Application: asset-manager - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/apps/asset-manager.html">

      <meta name="description" content="Everything about the asset-manager application (Manages uploaded assets (images, PDFs etc.) for applications on GOV.UK)" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta name="twitter:title" content="Application: asset-manager - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/apps/asset-manager.html" />

      <meta property="og:description" content="Everything about the asset-manager application (Manages uploaded assets (images, PDFs etc.) for applications on GOV.UK)" />
      <meta property="og:image" content="https://docs.publishing.service.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Application: asset-manager" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/apps/asset-manager.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__logotype">
          <svg
            aria-hidden="true"
            focusable="false"
            class="govuk-header__logotype-crown"
            xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 132 97"
            height="30"
            width="36"
          >
            <path
              fill="currentColor" fill-rule="evenodd"
              d="M25 30.2c3.5 1.5 7.7-.2 9.1-3.7 1.5-3.6-.2-7.8-3.9-9.2-3.6-1.4-7.6.3-9.1 3.9-1.4 3.5.3 7.5 3.9 9zM9 39.5c3.6 1.5 7.8-.2 9.2-3.7 1.5-3.6-.2-7.8-3.9-9.1-3.6-1.5-7.6.2-9.1 3.8-1.4 3.5.3 7.5 3.8 9zM4.4 57.2c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.5-1.5-7.6.3-9.1 3.8-1.4 3.5.3 7.6 3.9 9.1zm38.3-21.4c3.5 1.5 7.7-.2 9.1-3.8 1.5-3.6-.2-7.7-3.9-9.1-3.6-1.5-7.6.3-9.1 3.8-1.3 3.6.4 7.7 3.9 9.1zm64.4-5.6c-3.6 1.5-7.8-.2-9.1-3.7-1.5-3.6.2-7.8 3.8-9.2 3.6-1.4 7.7.3 9.2 3.9 1.3 3.5-.4 7.5-3.9 9zm15.9 9.3c-3.6 1.5-7.7-.2-9.1-3.7-1.5-3.6.2-7.8 3.7-9.1 3.6-1.5 7.7.2 9.2 3.8 1.5 3.5-.3 7.5-3.8 9zm4.7 17.7c-3.6 1.5-7.8-.2-9.2-3.8-1.5-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.3 3.5-.4 7.6-3.9 9.1zM89.3 35.8c-3.6 1.5-7.8-.2-9.2-3.8-1.4-3.6.2-7.7 3.9-9.1 3.6-1.5 7.7.3 9.2 3.8 1.4 3.6-.3 7.7-3.9 9.1zM69.7 17.7l8.9 4.7V9.3l-8.9 2.8c-.2-.3-.5-.6-.9-.9L72.4 0H59.6l3.5 11.2c-.3.3-.6.5-.9.9l-8.8-2.8v13.1l8.8-4.7c.3.3.6.7.9.9l-5 15.4v.1c-.2.8-.4 1.6-.4 2.4 0 4.1 3.1 7.5 7 8.1h.2c.3 0 .7.1 1 .1.4 0 .7 0 1-.1h.2c4-.6 7.1-4.1 7.1-8.1 0-.8-.1-1.7-.4-2.4V34l-5.1-15.4c.4-.2.7-.6 1-.9zM66 92.8c16.9 0 32.8 1.1 47.1 3.2 4-16.9 8.9-26.7 14-33.5l-9.6-3.4c1 4.9 1.1 7.2 0 10.2-1.5-1.4-3-4.3-4.2-8.7L108.6 76c2.8-2 5-3.2 7.5-3.3-4.4 9.4-10 11.9-13.6 11.2-4.3-.8-6.3-4.6-5.6-7.9 1-4.7 5.7-5.9 8-.5 4.3-8.7-3-11.4-7.6-8.8 7.1-7.2 7.9-13.5 2.1-21.1-8 6.1-8.1 12.3-4.5 20.8-4.7-5.4-12.1-2.5-9.5 6.2 3.4-5.2 7.9-2 7.2 3.1-.6 4.3-6.4 7.8-13.5 7.2-10.3-.9-10.9-8-11.2-13.8 2.5-.5 7.1 1.8 11 7.3L80.2 60c-4.1 4.4-8 5.3-12.3 5.4 1.4-4.4 8-11.6 8-11.6H55.5s6.4 7.2 7.9 11.6c-4.2-.1-8-1-12.3-5.4l1.4 16.4c3.9-5.5 8.5-7.7 10.9-7.3-.3 5.8-.9 12.8-11.1 13.8-7.2.6-12.9-2.9-13.5-7.2-.7-5 3.8-8.3 7.1-3.1 2.7-8.7-4.6-11.6-9.4-6.2 3.7-8.5 3.6-14.7-4.6-20.8-5.8 7.6-5 13.9 2.2 21.1-4.7-2.6-11.9.1-7.7 8.8 2.3-5.5 7.1-4.2 8.1.5.7 3.3-1.3 7.1-5.7 7.9-3.5.7-9-1.8-13.5-11.2 2.5.1 4.7 1.3 7.5 3.3l-4.7-15.4c-1.2 4.4-2.7 7.2-4.3 8.7-1.1-3-.9-5.3 0-10.2l-9.5 3.4c5 6.9 9.9 16.7 14 33.5 14.8-2.1 30.8-3.2 47.7-3.2z"
            ></path>
            <image src="/assets/images/govuk-logotype-crown.png" xlink:href="" class="govuk-header__logotype-crown-fallback-image" width="36" height="32"></image>
          </svg>
          <span class="govuk-header__logotype-text">
            GOV.UK
          </span>
        </span>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Dashboard</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input class="govuk-input govuk-!-margin-bottom-4" id="search" name="q" type="text" aria-controls="search-results" placeholder="Search">
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/apps/by-team.html">
        <span>Application ownership by team</span>
      </a>
    </li>

      <li>
        <a href="/apps.html">
          <span>APIs</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/asset-manager.html" class="toc-link--in-view"><span>asset-manager</span></a></li>
          <li><a href="/apps/content-store.html"><span>content-store</span></a></li>
          <li><a href="/apps/email-alert-api.html"><span>email-alert-api</span></a></li>
          <li><a href="/apps/hmrc-manuals-api.html"><span>hmrc-manuals-api</span></a></li>
          <li><a href="/apps/imminence.html"><span>imminence</span></a></li>
          <li><a href="/apps/link-checker-api.html"><span>link-checker-api</span></a></li>
          <li><a href="/apps/mapit.html"><span>mapit</span></a></li>
          <li><a href="/apps/publishing-api.html"><span>publishing-api</span></a></li>
          <li><a href="/apps/router-api.html"><span>router-api</span></a></li>
          <li><a href="/apps/search-api.html"><span>search-api</span></a></li>
          <li><a href="/apps/support-api.html"><span>support-api</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Supporting apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/authenticating-proxy.html"><span>authenticating-proxy</span></a></li>
          <li><a href="/apps/content-data-admin.html"><span>content-data-admin</span></a></li>
          <li><a href="/apps/content-data-api.html"><span>content-data-api</span></a></li>
          <li><a href="/apps/govuk-load-testing.html"><span>govuk-load-testing</span></a></li>
          <li><a href="/apps/release.html"><span>release</span></a></li>
          <li><a href="/apps/router.html"><span>router</span></a></li>
          <li><a href="/apps/search-admin.html"><span>search-admin</span></a></li>
          <li><a href="/apps/signon.html"><span>signon</span></a></li>
          <li><a href="/apps/support.html"><span>support</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Transition apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/bouncer.html"><span>bouncer</span></a></li>
          <li><a href="/apps/side-by-side-browser.html"><span>side-by-side-browser</span></a></li>
          <li><a href="/apps/transition.html"><span>transition</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Services</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/cache-clearing-service.html"><span>cache-clearing-service</span></a></li>
          <li><a href="/apps/email-alert-service.html"><span>email-alert-service</span></a></li>
          <li><a href="/apps/search-analytics.html"><span>search-analytics</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Frontend apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/calculators.html"><span>calculators</span></a></li>
          <li><a href="/apps/collections.html"><span>collections</span></a></li>
          <li><a href="/apps/email-alert-frontend.html"><span>email-alert-frontend</span></a></li>
          <li><a href="/apps/feedback.html"><span>feedback</span></a></li>
          <li><a href="/apps/finder-frontend.html"><span>finder-frontend</span></a></li>
          <li><a href="/apps/frontend.html"><span>frontend</span></a></li>
          <li><a href="/apps/government-frontend.html"><span>government-frontend</span></a></li>
          <li><a href="/apps/info-frontend.html"><span>info-frontend</span></a></li>
          <li><a href="/apps/licence-finder.html"><span>licence-finder</span></a></li>
          <li><a href="/apps/manuals-frontend.html"><span>manuals-frontend</span></a></li>
          <li><a href="/apps/service-manual-frontend.html"><span>service-manual-frontend</span></a></li>
          <li><a href="/apps/smart-answers.html"><span>smart-answers</span></a></li>
          <li><a href="/apps/static.html"><span>static</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>data.gov.uk apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/ckanext-datagovuk.html"><span>ckanext-datagovuk</span></a></li>
          <li><a href="/apps/datagovuk_find.html"><span>datagovuk_find</span></a></li>
          <li><a href="/apps/datagovuk_publish.html"><span>datagovuk_publish</span></a></li>
          <li><a href="/apps/datagovuk_reference.html"><span>datagovuk_reference</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Publishing apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/collections-publisher.html"><span>collections-publisher</span></a></li>
          <li><a href="/apps/contacts-admin.html"><span>contacts-admin</span></a></li>
          <li><a href="/apps/content-publisher.html"><span>content-publisher</span></a></li>
          <li><a href="/apps/content-tagger.html"><span>content-tagger</span></a></li>
          <li><a href="/apps/local-links-manager.html"><span>local-links-manager</span></a></li>
          <li><a href="/apps/manuals-publisher.html"><span>manuals-publisher</span></a></li>
          <li><a href="/apps/maslow.html"><span>maslow</span></a></li>
          <li><a href="/apps/publisher.html"><span>publisher</span></a></li>
          <li><a href="/apps/service-manual-publisher.html"><span>service-manual-publisher</span></a></li>
          <li><a href="/apps/short-url-manager.html"><span>short-url-manager</span></a></li>
          <li><a href="/apps/specialist-publisher.html"><span>specialist-publisher</span></a></li>
          <li><a href="/apps/travel-advice-publisher.html"><span>travel-advice-publisher</span></a></li>
          <li><a href="/apps/whitehall.html"><span>whitehall</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>GOV.UK Account</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/govuk-account-manager-prototype.html"><span>govuk-account-manager-prototype</span></a></li>
          <li><a href="/apps/govuk-attribute-service-prototype.html"><span>govuk-attribute-service-prototype</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Utilities</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/govuk-alert-tracker.html"><span>govuk-alert-tracker</span></a></li>
          <li><a href="/apps/govuk-content-store-examples.html"><span>govuk-content-store-examples</span></a></li>
          <li><a href="/apps/govuk-dependencies.html"><span>govuk-dependencies</span></a></li>
          <li><a href="/apps/govuk-display-screen.html"><span>govuk-display-screen</span></a></li>
          <li><a href="/apps/govuk-docker.html"><span>govuk-docker</span></a></li>
          <li><a href="/apps/govuk-pact-broker.html"><span>govuk-pact-broker</span></a></li>
          <li><a href="/apps/govuk-puppet.html"><span>govuk-puppet</span></a></li>
          <li><a href="/apps/govuk-secondline-blinken.html"><span>govuk-secondline-blinken</span></a></li>
          <li><a href="/apps/govuk-zendesk-display-screen.html"><span>govuk-zendesk-display-screen</span></a></li>
          <li><a href="/apps/seal.html"><span>seal</span></a></li>
          <li><a href="/apps/search-performance-explorer.html"><span>search-performance-explorer</span></a></li>
          <li><a href="/apps/side-by-side-browser.html"><span>side-by-side-browser</span></a></li>
          <li><a href="/apps/tech-docs-monitor.html"><span>tech-docs-monitor</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Data science</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/govuk-knowledge-graph.html"><span>govuk-knowledge-graph</span></a></li>
          <li><a href="/apps/govuk-related-links-recommender.html"><span>govuk-related-links-recommender</span></a></li>
        </ul>
      </li>
      <li>
        <a href="/apps.html">
          <span>Licensing apps</span>
        </a>
      </li>
      <li>
        <ul class='subnav'>
          <li><a href="/apps/licensify.html"><span>licensify</span></a></li>
        </ul>
      </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 class="page-title">Application: asset-manager</h1>

  <p>Manages uploaded assets (images, PDFs etc.) for applications on GOV.UK</p>

<h2 id="ownership">Ownership</h2>

<p><strong>#govuk-platform-health</strong> owns the application and is responsible for updating its dependencies.</p>

<h2 id="hosting">Hosting</h2>

<p>The production version of this application is hosted on <strong>AWS</strong>.</p>

<h3 id="ssh-access-aws">SSH Access (AWS)</h3>

<div class="highlight"><pre class="highlight shell"><code>gds govuk connect ssh <span class="nt">-e</span> integration backend
gds govuk connect ssh <span class="nt">-e</span> staging aws/backend
gds govuk connect ssh <span class="nt">-e</span> production aws/backend
</code></pre></div>
<h2 id="run-a-rake-task">Run a rake task</h2>

<ul>
  <li><a href="https://deploy.integration.publishing.service.gov.uk/job/run-rake-task/parambuild/?TARGET_APPLICATION=asset-manager&amp;MACHINE_CLASS=backend&amp;RAKE_TASK=">Run a Rake task on Integration</a></li>
<li><a href="https://deploy.blue.staging.govuk.digital/job/run-rake-task/parambuild/?TARGET_APPLICATION=asset-manager&amp;MACHINE_CLASS=backend&amp;RAKE_TASK=">Run a Rake task on Staging</a></li>
<li><a href="https://deploy.blue.production.govuk.digital/job/run-rake-task/parambuild/?TARGET_APPLICATION=asset-manager&amp;MACHINE_CLASS=backend&amp;RAKE_TASK=">⚠️ Run a Rake task on Production ⚠️</a></li>
</ul>

<h2 id="links">Links</h2>

<ul>
  <li><a href="https://github.com/alphagov/asset-manager">GitHub repo</a></li>

    <li><a href="https://sentry.io/govuk/app-asset-manager">Sentry (error tracking)</a></li>


    <li><a href="https://github.com/alphagov/govuk-puppet/blob/master/modules/govuk/manifests/apps/asset_manager.pp">Puppet configuration</a></li>

    <li><a href="https://github.com/alphagov/govuk-app-deployment/blob/master/asset-manager/config/deploy.rb">Deploy scripts</a></li>

    <li><a href="https://grafana.production.govuk.digital/dashboard/file/asset-manager.json">Deployment dashboard</a></li>





</ul>

<h3 id="relevant-manual-pages">Relevant manual pages</h3>

<ul>
  <li><a href="/manual/assets.html">Assets: how they work</a></li>
</ul>

<h2 id="readme">README</h2>

<div class="govuk-warning-text">
    <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
    <strong class="govuk-warning-text__text">
      <span class="govuk-warning-text__assistive">Warning</span>
      The content below is pulled in directly from the repository.<br />
      Links might not function properly.
    </strong>
  </div>

<div class="embedded-readme">
    
<p>Manages uploaded assets (images, PDFs etc.) for applications in the GOV.UK Publishing stack.</p>
<h2 id="technical-documentation">Technical Documentation</h2>
<p>This is a small Rails application that receives uploaded files from publishing applications and returns the URLs that they will be made available at. Before an asset is available to the public, it is virus scanned. Once a file is found to be clean, Asset Manager serves it at the previously generated URL. Unscanned or Infected files return a 404 Not Found error.</p>
<p>Scanning uses <a href="https://www.clamav.net/">ClamAV</a> and occurs asynchronously via <a href="https://github.com/alphagov/govuk_sidekiq">govuk_sidekiq</a>.</p>
<h3 id="dependencies">Dependencies</h3>
<ul>
<li>
<a href="https://www.mongodb.org/">MongoDB</a> via <a href="https://github.com/mongodb/mongoid">Mongoid</a>
</li>
<li><a href="https://github.com/alphagov/govuk_sidekiq">govuk_sidekiq</a></li>
<li>govuk_clamscan</li>
</ul>
<p>Virus scanning expects <code>govuk_clamscan</code> to exist on the PATH, and to be symlinked to either <code>clamscan</code> or <code>clamdscan</code>, which are part of <code>clamav</code>. This is configured by <a href="https://github.com/alphagov/govuk-puppet/blob/master/modules/clamav/manifests/package.pp">govuk-puppet</a>.</p>
<h3 id="assets-on-s3">Assets on S3</h3>
<p>All assets are uploaded to the S3 bucket via a separate <code>govuk_sidekiq</code> job triggered if virus scanning succeeds. Assets are currently still also saved to the NFS mount as per the original behaviour.</p>
<h4 id="standard-aws-environment-variables-required-in-production">Standard AWS environment variables (required in production)</h4>
<ul>
<li><code>AWS_ACCESS_KEY_ID</code></li>
<li><code>AWS_SECRET_ACCESS_KEY</code></li>
<li><code>AWS_REGION</code></li>
</ul>
<h4 id="application-specific-environment-variables">Application-specific environment variables</h4>
<ul>
<li>
<code>AWS_S3_BUCKET_NAME</code> - name of bucket where assets are to be stored (required in production)</li>
</ul>
<h4 id="fake-s3">Fake S3</h4>
<p>In non-production environments if the <code>AWS_S3_BUCKET_NAME</code> environment variable is not set, then a fake version of S3 (<code>S3Storage::Fake</code>) is used and the other <code>AWS_*</code> environment variables do not need to be set. In this case, files are saved to the local filesystem instead of S3 and are served via an instance of <code>Rack::File</code> mounted on the appropriate route path prefix.</p>
<h3 id="development">Development</h3>
<p>Previously, the Rails app received <code>X-Sendfile-Type</code> &amp; <code>X-Accel-Mapping</code> request headers and set the <code>X-Accel-Redirect</code> response header which caused <code>Rack::Sendfile</code> not to send the asset file in the body of the response. Nginx would interpret the <code>X-Accel-Redirect</code> response header and serve the file directly from disk. When running the app standalone (i.e. without Nginx) the app would not receive the request headers mentioned above. This in turn caused <code>Rack::Sendfile</code> to send the asset file in the body of the response. Thus it was possible to use the app running standalone to serve asset requests.</p>
<p>However, now the app doesn't make use of <code>Rack::Sendfile</code> and instead <em>always</em> responds to asset requests by setting the <code>X-Accel-Redirect</code> response header and <em>not</em> sending the asset file in the response body. Nginx is configured to proxy the request to the URL supplied in <code>X-Accel-Redirect</code> response header on the development VM, but if you want to run the app standalone and you want to actually serve the asset file in the response body, you'll need something (e.g. Nginx) in front of the Rails app.</p>
<h3 id="testing">Testing</h3>
<p><code>bundle exec rspec</code></p>
<h3 id="api">API</h3>
<p><code>POST /assets</code> expects a single file uploaded via the <code>asset[file]</code> parameter. This creates the asset and schedules it for scanning.</p>
<p><code>PUT /assets/:id</code> expects a file in the same format, and replaces it at the provided ID.</p>
<p><code>GET /assets/:id</code> returns information about the requested asset, but not the asset itself.</p>
<p><code>DELETE /assets/:id</code> marks the asset as having been deleted.</p>
<p><code>POST /assets/:id/restore</code> restores a previously deleted asset.</p>
<p>See the <code>AssetPresenter</code> class for the return format for the above API calls. All API requests must be authenticated with a token generated in the Signon application.</p>
<p><code>GET /media/:id/:filename</code> serves the file to the user if it is marked as clean.</p>
<p><code>POST /whitehall_assets</code> expects a single file uploaded via the <code>asset[file]</code> parameter and a path set in <code>asset[legacy_url_path]</code>. The latter tells Asset Manager the URL path at which the asset should be served. Note that this is intended as a transitional measure while we move Whitehall assets into Asset Manager. The idea is that eventually all asset URLs will be rationalised and consolidated and at that point Asset Manager will tell Whitehall the URL at which the asset will be served as it currently does for Mainstream assets. This endpoint also accepts two optional parameters, <code>asset[legacy_etag]</code> &amp; <code>asset[legacy_last_modified]</code>. These are only intended for use when we move <em>existing</em> Whitehall assets into Asset Manager so that we can avoid wholesale cache invalidation. <strong>Note</strong> this endpoint should only be used from the Whitehall Admin app; not from any other publishing apps.</p>
<h3 id="api-examples-development-vm">API examples (development VM)</h3>
<p>These examples assume you're using the <a href="https://github.com/alphagov/govuk-puppet/tree/master/development-vm">Development VM</a>.</p>
<h4 id="create-an-asset">Create an asset</h4>
<pre><code># Create a temporary file
vagrant@development:$ echo `date` &gt; tmp.txt

# Upload file to Asset Manager
vagrant@development:$ curl http://asset-manager.dev.gov.uk/assets --form "asset[file]=@tmp.txt"
{
  "_response_info":{"status":"created"},
  "id":"http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96",
  "name":"tmp.txt",
  "content_type":"text/plain",
  "file_url":"http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp.txt",
  "state":"unscanned"
}
</code></pre>
<h4 id="get-asset-info">Get asset info</h4>
<pre><code># Before virus scanning
vagrant@development:$ curl http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96
{
  "_response_info":{"status":"ok"},
  "id":"http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96",
  "name":"tmp.txt",
  "content_type":"text/plain",
  "file_url":"http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp.txt",
  "state":"unscanned"
}

# After virus scanning
vagrant@development:$ curl http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96
{
  "_response_info":{"status":"ok"},
  "id":"http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96",
  "name":"tmp.txt",
  "content_type":"text/plain",
  "file_url":"http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp.txt",
  "state":"clean"
}
</code></pre>
<h4 id="get-asset">Get asset</h4>
<pre><code># Before virus scanning
vagrant@development:$ curl http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp.txt
{
  "_response_info":{"status":"not found"}
}

# After virus scanning
vagrant@development:$ curl http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp.txt
Tue 18 Jul 2017 16:18:38 BST
</code></pre>
<h4 id="update-asset">Update asset</h4>
<pre><code># Create a new tmp file
vagrant@development:$ echo `date` &gt; tmp123.txt

# Update the file on asset-manager
vagrant@development:$ curl http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96 --request PUT --form "asset[file]=@tmp123.txt"
{
  "_response_info":{"status":"success"},
  "id":"http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96",
  "name":"tmp123.txt",
  "content_type":"text/plain",
  "file_url":"http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp123.txt",
  "state":"unscanned"
}

# Request asset using original filename
vagrant@development:$ curl http://asset-manager.dev.gov.uk/media/597b098a759b743e0b759a96/tmp.txt
&lt;html&gt;&lt;body&gt;You are being &lt;a href="/media/597b098a759b743e0b759a96/tmp123.txt"&gt;redirected&lt;/a&gt;.&lt;/body&gt;&lt;/html&gt;

# Request asset using latest filename
vagrant@development:$ curl http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp123.txt
Tue 18 Jul 2017 17:06:41 BST
</code></pre>
<h4 id="delete-asset">Delete asset</h4>
<pre><code># Delete the asset
vagrant@development:$ curl http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96 \
  --request DELETE
{
  "_response_info":{"status":"success"},
  "id":"http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96",
  "name":"tmp.txt",
  "content_type":"text/plain",
  "file_url":"http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp.txt",
  "state":"clean"
}

# Confirm that it's been deleted
vagrant@development:$ curl http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96
{
  "_response_info":{"status":"not found"}
}
</code></pre>
<h4 id="restore-asset">Restore asset</h4>
<pre><code># This assumes the asset has been deleted
vagrant@development:$ curl http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96/restore \
  --request POST
{
  "_response_info":{"status":"success"},
  "id":"http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96",
  "name":"tmp.txt",
  "content_type":"text/plain",
  "file_url":"http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp.txt",
  "state":"clean"
}

# Confirm that it's been restored
vagrant@development:$ curl http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96
{
  "_response_info":{"status":"ok"},
  "id":"http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96",
  "name":"tmp.txt",
  "content_type":"text/plain",
  "file_url":"http://assets-origin.dev.gov.uk/media/597b098a759b743e0b759a96/tmp.txt",
  "state":"clean"
}
</code></pre>
<h4 id="create-a-whitehall-asset">Create a Whitehall asset</h4>
<pre><code># Create a temporary file
vagrant@development:$ echo `date` &gt; tmp.txt

# Upload file to Asset Manager
vagrant@development:$ curl http://asset-manager.dev.gov.uk/whitehall_assets --form "asset[file]=@tmp.txt" --form "asset[legacy_url_path]=/government/uploads/path/to/tmp.txt"
{
  "_response_info":{"status":"created"},
  "id":"http://asset-manager.dev.gov.uk/assets/597b098a759b743e0b759a96",
  "name":"tmp.txt",
  "content_type":"text/plain",
  "file_url":"http://assets-origin.dev.gov.uk/government/uploads/path/to/tmp.txt",
  "state":"unscanned"
}
</code></pre>
<h3 id="api-examples-integration">API examples (integration)</h3>
<p>These examples assume you're running on a machine with access to the integration environment. You need to set two extra headers on all API requests:</p>
<ul>
<li><code>Authorization: Bearer &lt;bearer-token&gt;</code></li>
<li><code>Accept: application/json</code></li>
</ul>
<p>Note that a suitable value for the bearer token is stored in <code>/etc/govuk/manuals-publisher/env.d/ASSET_MANAGER_BEARER_TOKEN</code>. This
environment variable can be made available in a new shell by using:
<code>govuk_setenv manuals-publisher bash</code>.</p>
<h4 id="create-an-asset">Create an asset</h4>
<pre><code>deploy@integration-backend-1:$ echo `date` &gt; tmp.txt

deploy@integration-backend-1:$ cat tmp.txt
Wed Sep 20 14:42:54 UTC 2017

deploy@integration-backend-1:$ govuk_setenv manuals-publisher bash

deploy@integration-backend-1:$ curl \
  -H"Authorization: Bearer $ASSET_MANAGER_BEARER_TOKEN" \
  -H"Accept: application/json" \
  https://asset-manager.$GOVUK_APP_DOMAIN/assets \
  --form "asset[file]=@tmp.txt"

{
  "_response_info":{"status":"created"},
  "id":"https://asset-manager.integration.govuk-internal.digital/assets/59c282e2e5274a598a083a92",
  "name":"tmp.txt",
  "content_type":"text/plain",
  "file_url":"https://assets-origin.integration.publishing.service.gov.uk/media/597b098a759b743e0b759a96/tmp.txt",
  "state":"unscanned"
}
</code></pre>
<h4 id="get-asset-info">Get asset info</h4>
<pre><code>deploy@integration-backend-1:$ curl \
  -H"Authorization: Bearer $ASSET_MANAGER_BEARER_TOKEN" \
  -H"Accept: application/json" \
  https://asset-manager.$GOVUK_APP_DOMAIN/assets/59c282e2e5274a598a083a92
{
  "_response_info":{"status":"ok"},
  "id":"https://asset-manager.integration.govuk-internal.digital/assets/59c282e2e5274a598a083a92",
  "name":"tmp.txt",
  "content_type":"text/plain",
  "file_url":"https://assets-origin.integration.publishing.service.gov.uk/media/597b098a759b743e0b759a96/tmp.txt",
  "state":"clean"
}
</code></pre>
<h4 id="get-asset">Get asset</h4>
<p>Note that the extra request headers are not required for public asset URLs.</p>
<pre><code>deploy@integration-backend-1:$ curl https://assets-origin.integration.publishing.service.gov.uk/media/597b098a759b743e0b759a96/tmp.txt
Wed Sep 20 14:42:54 UTC 2017
</code></pre>
<h2 id="licence">Licence</h2>
<p><a href="https://github.com/alphagov/asset-manager/blob/master/LICENCE">MIT License</a></p>
  </div>



            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/data/applications.yml">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?labels=bug&amp;title=Re:%20''&amp;body=Problem%20with%20''%20(https://docs.publishing.service.gov.uk/apps/asset-manager.html)">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/application.js"></script>
  </body>
</html>
